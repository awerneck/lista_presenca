{% extends "base.html" %}
{% block title %}Painel Admin{% endblock %}
{% block content %}
<h2 class="h5 mb-3">Painel Administrativo</h2>

<div class="card mb-3 p-3">
  <form id="filtroForm" class="row g-2 align-items-end" aria-label="Filtros">
    <div class="col-12 col-md-5">
      <label class="form-label visually-hidden" for="nomeFiltro">Nome</label>
      <input id="nomeFiltro" class="form-control" placeholder="Buscar por nome (parte do nome)">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label visually-hidden" for="fromFiltro">Data de</label>
      <input id="fromFiltro" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label visually-hidden" for="toFiltro">Data até</label>
      <input id="toFiltro" type="date" class="form-control">
    </div>
    <div class="col-12 col-md-1 d-grid">
      <button id="btnFiltrar" class="btn btn-primary" type="button">OK</button>
    </div>
  </form>

  <div class="mt-2">
    <a id="exportCsv" class="btn btn-outline-secondary btn-sm me-2" role="button">Exportar CSV</a>
    <a id="exportPdf" class="btn btn-outline-secondary btn-sm" role="button">Exportar PDF</a>
  </div>
</div>

<!-- Config card -->
<div class="card mb-3 p-3">
  <h6>Configuração: Tema do DQS & Assinatura</h6>
  <form id="configForm" method="POST" action="/admin/config" class="row g-2">
    <div class="col-12 col-md-6">
      <label for="temaInput" class="form-label visually-hidden">Tema</label>
      <input id="temaInput" name="tema" class="form-control" placeholder="Tema do DQS" value="{{ config.tema if config else '' }}">
    </div>
    <div class="col-12 col-md-4">
      <label for="assinaturaInput" class="form-label visually-hidden">Assinatura</label>
      <input id="assinaturaInput" name="assinatura" class="form-control" placeholder="Assinatura" value="{{ config.assinatura if config else '' }}">
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button class="btn btn-success" type="submit">Salvar</button>
    </div>
  </form>
</div>

<div class="row g-3">
  <div class="col-12 col-md-6">
    <div class="card p-3 h-100">
      <h6>Presenças por dia</h6>
      <div style="height:300px"><canvas id="chartDia" aria-label="Gráfico por dia" role="img"></canvas></div>
    </div>
  </div>
  <div class="col-12 col-md-6">
    <div class="card p-3 h-100">
      <h6>Presenças por mês</h6>
      <div style="height:300px"><canvas id="chartMes" aria-label="Gráfico por mês" role="img"></canvas></div>
    </div>
  </div>
  <div class="col-12 mt-3">
    <div class="card p-3">
      <h6>Presenças por setor</h6>
      <div style="height:300px"><canvas id="chartSetor" aria-label="Gráfico por setor" role="img"></canvas></div>
    </div>
  </div>
</div>

<div class="card p-3 mt-3">
  <h6>Registros</h6>
  <div class="table-responsive" style="max-height:420px; overflow:auto;">
    <table class="table table-striped table-hover table-sm" id="tabelaDados">
      <thead class="table-light sticky-top">
        <tr>
          <th scope="col">Nome</th>
          <th scope="col">Matrícula</th>
          <th scope="col">Setor</th>
          <th scope="col">Data/Hora</th>
          <th scope="col">IP</th>
          </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let cDia, cMes, cSetor;

async function carregarDados(){
  const nome = document.getElementById('nomeFiltro').value || '';
  const data_from = document.getElementById('fromFiltro').value || '';
  const data_to = document.getElementById('toFiltro').value || '';
  const qs = new URLSearchParams({nome, data_from, data_to});
  const res = await fetch('/admin/data?' + qs.toString());
  const j = await res.json();

  // tabela
  const tbody = document.querySelector('#tabelaDados tbody');
  tbody.innerHTML = '';
  (j.records || []).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r["Nome"]||''}</td>
      <td>${r["Matrícula"]||''}</td>
      <td>${r["Setor"]||''}</td>
      <td>${r["Data/Hora"]||''}</td>
      <td>${r["IP"]||''}</td>
      
    `;
    tbody.appendChild(tr);
  });

  // charts
  const byDay = j.by_day || [];
  const byMonth = j.by_month || [];
  const bySetor = j.by_setor || [];

  const labelsDay = byDay.map(x => x.Data);
  const dataDay = byDay.map(x => x.count);

  const labelsMonth = byMonth.map(x => x.Month);
  const dataMonth = byMonth.map(x => x.count);

  const labelsSetor = bySetor.map(x => x.Setor);
  const dataSetor = bySetor.map(x => x.count);

  if(cDia) cDia.destroy();
  cDia = new Chart(document.getElementById('chartDia'), {
    type: 'bar',
    data: { labels: labelsDay, datasets: [{ label: 'Presenças', data: dataDay }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  if(cMes) cMes.destroy();
  cMes = new Chart(document.getElementById('chartMes'), {
    type: 'line',
    data: { labels: labelsMonth, datasets: [{ label: 'Presenças', data: dataMonth, fill:true }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  if(cSetor) cSetor.destroy();
  cSetor = new Chart(document.getElementById('chartSetor'), {
    type: 'pie',
    data: { labels: labelsSetor, datasets: [{ data: dataSetor }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  // links export
  const base = '/export?'+qs.toString();
  document.getElementById('exportCsv').href = base;
  document.getElementById('exportPdf').href = '/export_pdf?'+qs.toString();
}

document.getElementById('btnFiltrar').addEventListener('click', carregarDados);
window.addEventListener('load', carregarDados);
</script>

{% endblock %}

